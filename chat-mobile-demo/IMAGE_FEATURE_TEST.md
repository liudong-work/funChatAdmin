# 图片消息功能测试说明

## 功能概述
实现了聊天应用的图片消息发送和接收功能，基于 WebSocket 二进制直传方式。

## 已完成的功能

### 1. 前端实现 (ChatDetailScreen.js)
- ✅ 安装并配置 `expo-image-picker` 依赖
- ✅ 在输入框左侧添加图片选择按钮（🖼️ 图标）
- ✅ 实现图片选择、读取和通过 WebSocket 发送
- ✅ 实现图片消息的本地预览显示
- ✅ 实现接收到的图片消息展示
- ✅ 添加详细的调试日志

### 2. 后端实现 (server-simple.js)
- ✅ WebSocket `image_message` 事件监听
- ✅ 图片数据接收和保存到 uploads 目录
- ✅ 图片消息存储到对话历史
- ✅ 图片消息推送给接收者
- ✅ 发送者收到发送确认

### 3. 全局 WebSocket 处理 (App.js)
- ✅ 添加 `image_message` 事件监听
- ✅ 将图片消息转换为标准消息格式
- ✅ 通过 `handleNewMessage` 分发给聊天页面

## 测试步骤

### 准备工作
1. 确保后端服务运行在 http://localhost:3000
2. 确保 Expo Go 应用已连接
3. 至少需要两个测试账号进行消息收发测试

### 测试用例

#### 测试1：发送图片消息
1. 登录账号A，进入与账号B的聊天页面
2. 点击输入框左侧的 🖼️ 按钮
3. 选择一张图片
4. 检查控制台日志：
   - `[Image] 开始选择图片...`
   - `[Image] 相册权限状态: granted`
   - `[Image] 选中的图片:` (包含图片信息)
   - `[Image] 图片数据长度:` (字节数)
   - `[Image] 通过 WebSocket 发送图片消息...`
   - `[Image] 添加本地图片消息:`
5. 检查聊天界面是否显示发送的图片（右侧）

#### 测试2：接收图片消息
1. 账号A发送图片后
2. 在账号B的聊天页面检查：
   - 控制台日志：`[WS] 收到图片消息:`
   - 聊天界面显示接收到的图片（左侧）
   - 图片能正常加载显示

#### 测试3：历史消息加载
1. 发送若干图片消息后
2. 退出聊天页面
3. 重新进入聊天页面
4. 检查历史图片消息是否正确显示

#### 测试4：图片点击
1. 点击聊天中的图片
2. 检查控制台日志：`[Image] 点击图片消息:`
3. （当前为预留功能，后续可实现图片预览）

### 关键日志说明

#### 前端发送日志
```
[Image] 开始选择图片...
[Image] 相册权限状态: granted
[Image] 启动图片选择器...
[Image] 图片选择结果: { canceled: false, assetsCount: 1 }
[Image] 选中的图片: { uri: ..., width: ..., height: ..., mimeType: ... }
[Image] 用户信息: { from: ..., to: ... }
[Image] 开始读取图片文件...
[Image] 图片数据长度: 123456
[Image] 通过 WebSocket 发送图片消息...
[Image] 图片消息已发送，等待确认...
[Image] 添加本地图片消息: { ... }
```

#### 后端处理日志
```
[WS] 收到图片消息: { from: ..., to: ..., hasImageData: true, length: 123456, ... }
```

#### 前端接收日志
```
[WS] 收到图片消息: { sender: ..., receiver: ..., imageUrl: ..., width: ..., height: ... }
[ChatDetail] 收到回调消息: { content: '[图片消息]', type: 'image', ... }
[ChatDetail] 已插入一条消息，当前总数: 5
[Image] 图片加载成功: /uploads/img-123456.jpg
```

## 技术实现要点

### 1. WebSocket 二进制传输
- 前端：使用 `fetch` 读取图片为 `ArrayBuffer`，转换为 `Uint8Array`，再转为普通数组通过 JSON 传输
- 后端：接收数组数据，转换回 `Buffer`，写入文件系统

### 2. 图片 URL 处理
- 发送者：本地预览使用设备本地 URI
- 接收者：使用后端返回的服务器 URL (`/uploads/img-xxx.jpg`)
- 历史消息：统一使用服务器 URL

### 3. 消息类型标识
- `message.type = 'image'`
- `message.imageUrl` 存储图片 URL
- `message.width` 和 `message.height` 存储图片尺寸

## 已知限制
1. 图片大小未做限制（建议后续添加大小检查）
2. 图片格式未严格验证（依赖 expo-image-picker 的筛选）
3. 点击图片暂未实现全屏预览功能
4. 图片上传进度未显示

## 后续优化方向
1. 添加图片压缩功能（减少传输量）
2. 实现图片全屏预览
3. 添加上传进度显示
4. 支持多图片选择
5. 添加图片缓存机制
6. 优化大图片加载性能
